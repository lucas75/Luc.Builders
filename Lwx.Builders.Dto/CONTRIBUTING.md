# Contributing to Lwx.Builders.Dto

This document explains the architecture, design decisions, and how to start coding on this Roslyn incremental source generator.

## Architecture Overview

### Core Components

```
Lwx.Builders.Dto/
├── DtoGenerator.cs           # Main incremental generator
├── GeneratorUtils.cs         # Shared utilities
├── Attributes/               # Embedded attribute source files
│   ├── LwxDtoAttribute.cs
│   ├── LwxDtoPropertyAttribute.cs
│   ├── LwxDtoIgnoreAttribute.cs
│   └── DtoType.cs
└── Processors/               # Per-type processing logic
    └── LwxDtoTypeProcessor.cs
```

### How the Generator Works

1. **Attribute Embedding**: Attributes in `Attributes/` are embedded and emitted during `PostInitializationOutput` so consumer projects receive the attribute types as source.

2. **Syntax Collection**: The generator collects types annotated with `[LwxDto]`.

3. **Processing**: `LwxDtoTypeProcessor` validates the DTO and generates partial source files with:
   - Backing fields (Normal mode) or dictionary storage (Dictionary mode)
   - `[JsonPropertyName]` attributes
   - `[JsonIgnore]` for nullable properties
   - `[JsonConverter]` for custom converters
   - `[JsonStringEnumConverter]` for enum properties

### Key Design Decisions

- **Two Storage Modes**: `DtoType.Normal` (backing fields) and `DtoType.Dictionary` (dictionary-backed)
- **Partial Properties**: Consumer declares `partial` properties; generator provides implementation
- **Embedded Attributes**: Distributed as source, not runtime dependencies

## Development Environment

### Requirements

- .NET 9.0 SDK
- C# 13 features enabled

Verify SDK:
```bash
dotnet --list-sdks
```

### Build & Test

```bash
# Build the solution
dotnet build ./Lwx.Builders.sln

# Run all tests
dotnet test ./Lwx.Builders.sln --no-build

# Run only DTO generator tests
dotnet test ./Lwx.Builders.Dto.Tests/Lwx.Builders.Dto.Tests.csproj --no-build
```

## Coding Conventions

### Source Generation Style (Required)

Use raw interpolated string templates for generated code:

```csharp
srcBuilder.Append($$"""
{{variable}}.MethodCall();

""");
```

- **No embedded indentation** inside raw strings
- Apply `.FixIndent(levels)` at template inclusion sites
- Use file-scoped namespaces in generated files

### Code Style

- C# 13 with primary constructors and pattern matching
- PascalCase for all identifiers
- Comprehensive XML documentation for public APIs
- Prefer immutability and `readonly` fields
- Split large methods into smaller helpers
- Avoid `@"..."` verbatim strings

## Diagnostics

| Code | Description |
|------|-------------|
| LWX003 | Unsupported property type — needs converter |
| LWX004 | Enum missing `[JsonPropertyName]` (warning) |
| LWX005 | Property missing attribute |
| LWX006 | Fields not allowed in DTOs |
| LWX007 | Consider `DateTimeOffset` over `DateTime` |

When adding new diagnostics:
1. Define the descriptor in the processor
2. Add tests in `CompileErrorTests.cs`
3. Document here

## Testing Approach

### Test Organization

- **Runtime tests** (`PositiveTests.cs`, `NegativeTests.cs`): Fast tests using `System.Text.Json` at runtime
- **Structural tests** (`StructuralTests.cs`): Reflection-based inspection of generated types
- **Compile-error tests** (`CompileErrorTests.cs`): Validate diagnostics using MSBuild

### Test DTOs

Canonical test fixtures in `Dto/`:
- `NormalDto.cs` — Normal storage mode
- `DictDto.cs` — Dictionary storage mode
- `IgnoreDto.cs` — Ignored properties

### Sample Projects

Located in `SampleProjects/` for compile-time diagnostic tests. Keep them minimal and well-documented.

## Adding New Features

### Adding a New Property Type

1. Update `LwxDtoTypeProcessor` to recognize the type
2. Add appropriate JSON attributes to generated code
3. Add diagnostic if converter is required
4. Add runtime and structural tests

### Adding a New Diagnostic

1. Add descriptor in processor
2. Add sample project that triggers it
3. Add test in `CompileErrorTests.cs`
4. Document in this file

## Important Warnings

- **Never modify generated files** (files with `// <auto-generated/>`)
- **Never use `ReferenceOutputAssembly=true`** for generator references
- **Always run tests** before proposing changes
- **Keep runtime tests pure** — no reflection or MSBuild access in `PositiveTests`/`NegativeTests`

## Where to add changes

- Attributes: add new attribute source files under `Attributes/` and ensure tests cover any new behavior.
- Processors: extend `Processors/` with new validations or emission helpers.
- Tests: add Roslyn-driven tests to `Lwx.Builders.Dto.Tests` following the existing patterns.

## Notes

- The solution file in the repository is `Lwx.Builders.sln`.
- If you are unsure about a change, add or update generator-driver tests that demonstrate the desired behavior before changing emission logic.

Thank you for contributing! If you have questions about the generator internals, open an issue or reach out to a maintainer.
