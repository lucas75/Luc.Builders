# Contributing & Design Notes

This document contains design, development and testing guidance for contributors working on `Lwx.Builders.Dto`.

Use `README.md` for usage instructions; keep this file focused on implementation, tests, and how-to for maintainers.

## Architecture & Design

- Responsibilities:
  - Embed attribute source files so consumers receive attribute types as source.
  - Discover attributed DTO types using Roslyn syntax/semantic analysis.
  - Per-type processing implemented by `LwxDtoTypeProcessor` which validates DTOs and emits partial source files.

- Generated code:
  - Output is partial classes with names like `LwxDto_{TypeName}.g.cs`.
  - The generator supports `DtoType.Normal` (backing fields) and `DtoType.Dictionary` (dictionary-backed storage).
  - Enum properties receive `JsonStringEnumConverter` and the generator emits `JsonPropertyName`/`JsonIgnore` attributes where appropriate.

- Diagnostics:
  - `LWX003` — Unsupported property type: add a `JsonConverter`.
  - `LWX004` — Enum constants missing `JsonPropertyName` (warning).
  - `LWX005` — Property missing `LwxDtoProperty` or `LwxDtoIgnore`.
  - `LWX006` — Fields are not allowed inside DTO classes.

## Project layout

- `Attributes/` — attribute source files embedded or included by the generator.
- `Processors/` — per-type processing logic, primarily `LwxDtoTypeProcessor`.
- `Lwx.Builders.Dto.csproj` — main generator project (target: `net9.0`).
- `Lwx.Builders.Dto.Tests/` — Roslyn-driven unit tests.

## Development environment

- Target SDK: .NET 9.0 (use C# 13 features where helpful).
- Verify SDKs:

```bash
dotnet --list-sdks
```

Ensure `dotnet --list-sdks` shows .NET 9.0 or above before running builds/tests.

## Coding conventions & expectations

- Prefer immutability and `readonly` fields where meaningful.
- Avoid large methods; split into smaller helpers for clarity.
- Keep public APIs stable; do not rename or remove attributes unless necessary.
- Never modify generated files — treat files with `// <auto-generated/>` as read-only.
- Avoid verbatim `@"..."` strings in new sources.

## Build & test

Run a local build and tests:

```bash
dotnet build
dotnet test
```

To run only the generator tests:

```bash
dotnet test Lwx.Builders.Dto.Tests
```

## Testing approach (generator authors)

- Use Roslyn in-process generator-driver tests rather than filesystem/temp-project builds. Those tests:
  1. Create a `CSharpCompilation` with the consumer source.
  2. Run the generator via `CSharpGeneratorDriver` / `RunGenerators`.
  3. Assert on generated `SourceText` contents and on diagnostics reported.

- Add `Microsoft.CodeAnalysis.CSharp` and related packages to the test project when writing new tests.
- Keep tests deterministic: avoid IO, environment-dependent paths, or ephemeral projects.

## Diagnostics and how to handle them

- `LWX003`: If you see this, provide a converter: `[LwxDtoProperty(JsonConverter = typeof(MyConverter))]`.
- `LWX004`: Add `JsonPropertyName` to enum members if you want explicit JSON names.
- `LWX005`: Ensure properties either have `LwxDtoProperty` or `LwxDtoIgnore` to be intentionally included/excluded.
- `LWX006`: Remove fields from the DTO; generator supports properties only.

## Formatting and CI

- Run formatting before committing. If you use a formatter tool, run it limited to modified files to save time.
- CI should run `dotnet build` and `dotnet test`; consider adding a job that validates generator behavior against a small sample consumer project.

## AI agent / automation checklist (developer convenience)

These are helpful verification steps when automating or debugging changes:

1. Environment & SDK check
   - Ensure `dotnet --list-sdks` includes .NET 9.0 or above.

2. Build & test
   - Run `dotnet build && dotnet test` and fail if there are build/test errors.

3. Sanitization & security
   - Do not interpolate untrusted input into generated source. Always sanitize or validate input used to construct source.

## Where to add changes

- Attributes: add new attribute source files under `Attributes/` and ensure tests cover any new behavior.
- Processors: extend `Processors/` with new validations or emission helpers.
- Tests: add Roslyn-driven tests to `Lwx.Builders.Dto.Tests` following the existing patterns.

## Notes

- The solution file in the repository is `Lwx.Builders.sln`.
- If you are unsure about a change, add or update generator-driver tests that demonstrate the desired behavior before changing emission logic.

Thank you for contributing! If you have questions about the generator internals, open an issue or reach out to a maintainer.
