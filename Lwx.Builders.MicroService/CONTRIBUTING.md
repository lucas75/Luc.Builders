# Contributing to Lwx.Builders.MicroService

This document explains the architecture, design decisions, and how to start coding on this Roslyn incremental source generator.

## Architecture Overview

### Core Components

```
Lwx.Builders.MicroService/
├── Generator.cs              # Main incremental generator orchestration
├── GeneratorUtils.cs         # Shared utilities and AttributeInstance model
├── Attributes/               # Embedded attribute source files
│   ├── LwxEndpointAttribute.cs
│   ├── LwxWorkerAttribute.cs
│   ├── LwxServiceAttribute.cs
│   └── ...
├── Processors/               # Per-type processing logic
│   ├── LwxEndpointTypeProcessor.cs
│   ├── LwxWorkerTypeProcessor.cs
│   ├── LwxServiceTypeProcessor.cs
│   └── ProcessorUtils.cs
└── Utils/                    # Additional helpers
```

### How the Generator Works

1. **Attribute Embedding**: Attributes in `Attributes/` are embedded and emitted during `PostInitializationOutput` so consumer projects receive the attribute types as source.

2. **Syntax Collection**: The generator uses `ForAttributeWithMetadataName` to collect types annotated with `[LwxEndpoint]`, `[LwxWorker]`, `[LwxService]`.

3. **Processing**: Each attributed type is processed by its corresponding processor class which validates and generates partial source files.

4. **Service Association**: Endpoints and workers are associated with services by namespace hierarchy (e.g., `Assembly.Abc.Endpoints.Foo` belongs to `Assembly.Abc.Service`).

### Key Design Decisions

- **Incremental Generation**: Uses Roslyn's incremental generator API for performance.
- **Primary Constructors**: All processors use C# 13 primary constructors.
- **Namespace-Based Association**: Multi-service support via namespace matching.
- **Embedded Attributes**: Attributes are distributed as source, not runtime dependencies.

## Development Environment

### Requirements

- .NET 9.0 SDK
- C# 13 features enabled

Verify SDK:
```bash
dotnet --list-sdks
```

### Build & Test

```bash
# Build the solution
dotnet build ./Lwx.Builders.sln

# Run all tests
dotnet test ./Lwx.Builders.sln --no-build

# Run only MicroService generator tests
dotnet test ./Lwx.Builders.MicroService.Tests/Lwx.Builders.MicroService.Tests.csproj --no-build
```

## Coding Conventions

### Source Generation Style (Required)

Use raw interpolated string templates for generated code:

```csharp
srcBuilder.Append($$"""
{{variable}}.MethodCall();

""");
```

- **No embedded indentation** inside raw strings
- Apply `.FixIndent(levels)` at template inclusion sites
- Use file-scoped namespaces in generated files: `namespace Foo.Bar;`

### Code Style

- C# 13 with primary constructors and pattern matching
- PascalCase for all identifiers
- Comprehensive XML documentation for public APIs
- Prefer immutability and `readonly` fields
- Split large methods into smaller helpers
- Avoid `@"..."` verbatim strings

### Diagnostics

Custom diagnostics use codes `LWX001`-`LWX022`. When adding new diagnostics:
1. Define the descriptor in the processor
2. Add tests in `CompileErrorTests.cs`
3. Document in this file

| Code | Description |
|------|-------------|
| LWX007 | Namespace/filepath mismatch |
| LWX011 | Missing Service.cs |
| LWX012 | [LwxService] not in Service.cs |
| LWX017 | Duplicate service namespace |
| LWX018 | Endpoint not in .Endpoints namespace |
| LWX019 | Worker not in .Workers namespace |
| LWX021 | Orphan endpoint (no matching service) |
| LWX022 | Orphan worker (no matching service) |

## Adding New Features

### Adding a New Processor

1. Create `Processors/LwxNewTypeProcessor.cs` with primary constructor:
   ```csharp
   public class LwxNewTypeProcessor(AttributeInstance attr, SourceProductionContext ctx, Compilation compilation)
   {
       public void Execute() { /* ... */ }
   }
   ```

2. Add the attribute to `Attributes/`

3. Register in `Generator.cs` initialization

4. Add compile-time tests to `CompileErrorTests.cs`

### Adding a New Attribute Property

1. Update the attribute in `Attributes/`
2. Update the processor to read the new property
3. Update generated code templates
4. Add tests for the new behavior

## Testing Approach

- **Runtime tests** (`MockServerTests.cs`): Fast tests using TestHost
- **Compile-time tests** (`CompileErrorTests.cs`): Validate diagnostics using MSBuild

### MockServer Infrastructure

The `MockServices/MockServer.cs` provides test infrastructure for starting in-memory ASP.NET Core servers. **Do not modify without operator approval** — it's critical for test stability.

## Important Warnings

- **Never modify generated files** (files with `// <auto-generated/>`)
- **Never use `ReferenceOutputAssembly=true`** for generator references
- **Always run tests** before proposing changes
- **Update AGENTS.md** when making significant architectural changes
