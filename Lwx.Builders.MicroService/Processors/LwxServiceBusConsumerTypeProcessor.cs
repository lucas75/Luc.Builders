using Microsoft.CodeAnalysis;
using Lwx.Builders.MicroService;

namespace Lwx.Builders.MicroService.Processors;

internal class LwxServiceBusConsumerTypeProcessor(
    Generator parent,
    Compilation compilation,
    SourceProductionContext ctx,
    AttributeInstance attr
)
{
    public void Execute()
    {
        // enforce file path and namespace matching for classes marked with Lwx attributes
        ProcessorUtils.ValidateFilePathMatchesNamespace(attr.TargetSymbol, ctx);
        var name = ProcessorUtils.SafeIdentifier(attr.TargetSymbol.Name);
        var ns = attr.TargetSymbol.ContainingNamespace?.ToDisplayString() ?? "Generated";
        var source = $$"""
            // <auto-generated/>
            namespace {{ns}};

            public static partial class LwxServiceBusConsumer_Generated_{{name}}
            {
                // Detected attribute: {{attr.AttributeName}} on {{attr.TargetSymbol.Kind}} {{attr.TargetSymbol.Name}}
            }
            """;

        ProcessorUtils.AddGeneratedFile(ctx, $"LwxServiceBusConsumer_{name}.g.cs", source);
    }
}
